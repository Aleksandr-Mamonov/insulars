<html>

<head>
    <title>Game | {{ player_name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
        integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
        crossorigin="anonymous"></script>

    <style>
        .font-bigger {
            font-size: 1.5rem;
        }
        .card {
            min-width: 250px;
            width: 250px;
            min-height: 300px;
            display: inline-block;
            margin-left: 5px;
            text-align: center;
        }

        .card-active {
            min-width: 300px;
            width: 300px;
            min-height: 400px;
            display: inline-block;
            margin-left: 5px;
            text-align: center;
        }

        .overlay {
            top: 0;
            left: 0;
            padding-top: 100px;
            text-align: center;
            position: absolute;
            z-index: 100;
            min-width: 100%;
            min-height: 100%;
            border: rgb(0, 17, 255) 1px solid;
            background-color: lavender;
        }

        .card-effect {}

        .card-effect-success {
            background-color: #7FFF00;
        }

        .card-effect-failure {
            background-color: #DC143C;
            color: #fff;
        }

        .portrait {
            background: #FFEBCD;
            background-size: contain;
            background-repeat: no-repeat;
            min-height: 150px;
            max-height: 150px;
            min-width: 150px;
            max-width: 150px;
        }

        .portrait.active {
            border-radius: 20%;
            box-shadow:
              0 0 30px #f0f,
              -5px 0 8px #0ff,
              5px 0 8px #0ff;
        }

        .portrait p {
            overflow-wrap: break-word;
        }

        .portrait div span {
            background-color: #fff;
            opacity: 0.85;
            font-size: 1rem;
            color: #000;
            border-radius:10%;
        }

        #portrait-options img {
            width: 220px;
        }
    </style>
</head>
<!--todo - leader can not select himself for project team-->

<body>
    <div id="app">
        <div class="container">
            <div class="row py-2">
                <div class="col">
                    <p><a href="/">Новая игра</a></p>
                </div>

                <div class="col text-end">
                    <span style="color: #fef;" v-if="room.game" @click="debug = !debug">debug</span>
                </div>
            </div>

            <div class="row" v-if="debug === true">
                <div class="col">
                    <p>Common account: ${game.round_common_account_points}$ points</p>
                    <pre>${ game }$</pre>
                    <pre>Stage ${ roundStage }$</pre>
                </div>
            </div>
        </div>


        <div v-if="finalRating !== null" class="overlay">
            <h2>Игра окончена!</h2>
            <div v-for="rank in finalRating">${ rank[0] }$ - <points-badge :points="rank[1]"/></div>

            <button @click="finalRating = null; game = null">Закрыть</button>
        </div>

        <div v-if="roundResults !== null" class="overlay">
            Здание
            <span v-if="roundResults === false" style="color: red"> не построено</span>
            <span v-if="roundResults !== false" style="color: green">построено</span>

            <div>
                <button @click="roundResults = null">Закрыть</button>
            </div>
        </div>

        <div id="lobby-layout" v-if="room.game === null" class="container">
            <div class="row">
                <div class="col">
                    <h1>Лобби</h1>
                    <a href="/?room_id={{room_id}}" target="_blank">Пригласить другого игрока</a>

                    <!-- Player list -->
                    <div class="row">
                        <div class="col-12 mt-4">
                            <p>Сейчас в комнате:</p>
                        </div>

                        <div class="col-auto"
                             v-for="p in room.players">
                            <div class="portrait p-2 rounded-4"
                                 :style="{'background-image': 'url(/static/portrait' + (portraitIds[p.name] || 0) + '.jpg)'}">
                                <div>
                                    <p><span class="p-1"><strong>${ p.name }$</strong></span></p>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 my-3">
                            <button type="button"
                                    @click="showPortraitOptions = !showPortraitOptions"
                                    class="btn btn-sm btn-outline-secondary">${ !showPortraitOptions ? 'Выбрать портрет' : 'Готово' }$</button>

                            <div v-if="showPortraitOptions === true"
                                 id="portrait-options"
                                 class="mt-3">
                                {% for i in range(4) %}
                                    <div class="row">
                                        <div class="col">
                                        {% for j in range(4) %}
                                            <img src="{{ url_for('static', filename='portrait' ~ ((i * 4) + 1 + j) ~ '.jpg') }}"
                                                 class="border border-5"
                                                 :class="{'border-info': player.portrait_id === {{ (i * 4) + 1 + j }}}"
                                                 @click="selectPortrait({{ (i * 4) + 1 + j }})">
                                        {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="col-12 my-3">
                            <button :disabled="room.players.length < room.config.MIN_PLAYERS || room.players.length > room.config.MAX_PLAYERS"
                                    v-if="player.is_owner"
                                    class="btn btn-primary"
                                    @click="startGame">Начать игру</button>
                        </div>
                    </div>

                    <details v-if="player.is_owner">
                        <summary>Настроить</summary>

                        <div>
                            <label>Number of rounds
                                <input v-model="gameConfig.rounds" />
                            </label>
                        </div>
                        <div>
                            <label>Initial player points
                                <input v-model="gameConfig.initialPlayerPoints" />
                            </label>
                        </div>
                        <h4>Card effect visibility</h4>
                        <div>
                            <p>On success effect</p>
                            <label>Leader
                                <input type="checkbox" v-model="gameConfig.cardEffectVisibility.onSuccess.leader" />
                            </label>
                            <label>Players
                                <input type="checkbox" v-model="gameConfig.cardEffectVisibility.onSuccess.players" />
                            </label>
                        </div>
                        <div>
                            <p>On failure effect</p>
                            <label>Leader
                                <input type="checkbox" v-model="gameConfig.cardEffectVisibility.onFailure.leader" />
                            </label>
                            <label>PLayers
                                <input type="checkbox" v-model="gameConfig.cardEffectVisibility.onFailure.players" />
                            </label>
                        </div>

                        <h4>Card deck</h4>
                        <div v-for="(card, idx) in cardDeck" style="padding: 10px; margin: 10px; background: lightgray">
                            <label>Name
                                <input v-model="card.name" />
                            </label>
                            <label>Points to succeed
                                <input v-model="card.points_to_succeed" />
                            </label>
                            <label>Min team
                                <input v-model="card.min_team" />
                            </label>
                            <label>Max team
                                <input v-model="card.max_team" />
                            </label>
                            <div>
                                <label>On success
                                    <textarea rows=6 cols=70 v-model="card.on_success"></textarea>
                                </label>
                            </div>
                            <div>
                                <label>On failure
                                    <textarea rows=6 cols=70 v-model="card.on_failure"></textarea>
                                </label>
                            </div>

                            <button @click="rmCardFromGameDeck(idx)" v-if="cardDeck.length > 1">Rm card</button>
                        </div>

                        <button @click="addNewCardToGameDeck()">Add card</button>

                        <h5>Effect samples</h5>
                        <pre>{"type": "change_player_points", "payload": {"rounds_to_apply": 1, "points": 10,"players": []}}</pre>
                        <pre>{"type": "leadership_ban_next_time", "payload": {"player": null}}</pre>
                    </details>
                </div>
            </div>
        </div>

        <div id="game-layout" v-if="room.game !== null">
            <div class="container">
                <div class="row mb-3">
                    <div class="col">
                         <h5>Ваш счет: <points-badge :points="game.all_players_points && game.all_players_points[playerName]" /></h5>
                         <p>
                            <span>Раунд ${ game.round }$ / ${ game.rounds }$</span>
                            <span v-if="roundStage === 0">, мэр выбирает проект </span>
                            <span v-if="roundStage === 1">, мэр выбирает команду </span>
                            <span v-if="roundStage === 2 && (!isPlayerProjectParticipant() || !isActivePlayer())">, ждем результатов строительства</span>
                        </p>
                    </div>
                </div>

                <!-- Players list -->
                <div class="row mb-4">
                    <div class="col-auto mx-1"
                         v-for="pl in room.players">
                        <div class="portrait border p-2 rounded-4"
                             :style="{'background-image': 'url(/static/portrait' + (portraitIds[pl.name] || 0) + '.jpg)'}"
                             :class="{'active border-info border-5': game.active_player == pl.name, 'border-secondary-subtle': game.active_player != pl.name, 'shadow': projectTeamMembersSelection[pl.name]}">

                            <div>
                                <p>
                                    <input type="checkbox"
                                       style="width: 25px; height: 25px;"
                                       :disabled="(selectedProjectTeamMembers.length >= projectTeamMaxMembers && !selectedProjectTeamMembers.includes(pl.name))"
                                       v-model="projectTeamMembersSelection[pl.name]"
                                       v-if="isLeader() && roundStage === 1 && game.leader !== pl.name">
                                    <span class="p-1">
                                        <strong>
                                            ${ pl.name }$
                                        </strong>
                                    </span>

                                    <span class="p-1 m-1 text-white bg-primary" v-if="pl.name == game.leader">мэр</span>
                                    <span class="p-1 m-1 text-white bg-success" v-if="game.team && game.team.includes(pl.name)">команда</span>
                                </p>
                            </div>

                        </div>
                    </div>

                    <div v-if="isLeader() && roundStage === 1">
                        <div class="row mt-3">
                            <div class="col">
                                <button type="button"
                                        class="btn btn-primary"
                                        @click="submitProjectTeamSelection() && projectTeamMembersSelection.length > 0">Подтвердить выбор команды</button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Cards -->
                <div class="row justify-content-sm-center bg-gradient py-4">
                    <div class="col">
                        <div v-if="game.cards_on_table && game.cards_on_table.length > 0">
                            <div v-if="isLeader()">
                                <div class="row">
                                    <div class="col">
                                        <table-card @click="selectedCard = card.card_id"
                                            :card="card"
                                            :class="{'border-3 shadow-lg border-info': selectedCard && (selectedCard === card.card_id)}"
                                            v-for="card in game.cards_on_table"
                                            :key="card.card_id"
                                            :effects-visibility="game.card_effect_visibility"
                                            :is-leader="isLeader()" />

                                    </div>
                                </div>

                                <div class="row mt-3">
                                    <div class="col">
                                        <button type="button"
                                                class="btn btn-primary"
                                                @click="submitCardsSelection()"
                                                :disabled="!selectedCard">Подтвердить выбор проекта</button>
                                    </div>
                                </div>
                            </div>

                            <div v-if="!isLeader()">
                                <div class="row">
                                    <div class="col">
                                        <table-card :card="card"
                                                    v-for="card in game.cards_on_table"
                                                    :key="card.card_id"
                                                    :effects-visibility="game.card_effect_visibility"
                                                    :is-leader="isLeader()"/>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div v-if="roundStage > 0">
                            <div class="row">
                                <div class="col">
                                    <table-card :card="card"
                                                v-for="card in game.cards_selected_by_leader"
                                                :key="card.card_id"
                                                :effects-visibility="game.card_effect_visibility"
                                                :is-leader="isLeader()"/>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>

                <!-- Current state notification -->
                <div class="row justify-content-sm-center py-3">
                    <div class="col">
                        <div v-if="roundStage === 2 && isPlayerProjectParticipant() && isActivePlayer()">
                            <label>Выберите, сколько вложить в проект: ${ playerProjectBid }$</label>
                            <input type="range"
                                   v-model="playerProjectBid"
                                   min="0"
                                   :max="game.all_players_points[playerName]" />

                            <div class="row mt-3">
                                <div class="col">
                                    <button type="button"
                                            class="btn btn-primary"
                                            @click="makeProjectDeposit(playerProjectBid)">Подтвердить</button>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>

                <!-- Effects to apply -->
                <div class="row justify-content-sm-center">
                    <div class="col">
                        <div v-if="game.effects_to_apply && game.effects_to_apply.length > 0">
                            Действующие эффекты:
                            <ul>
                                <li v-for="effect in game.effects_to_apply">
                                    <span v-if="effect.name == 'change_player_points'">
                                        <span>Изменение очков: <points-badge :points="effect.payload.points" :signed="true" :duration="effect.payload.rounds_to_apply"/></span>
                                        <span> для ${ effect.payload.players.join(', ') }$</span>
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <template id="TableCard">
        <div class="card shadow-sm mx-3 border-1 py-4">
            <h6>${ card.name }$</h6>
            <p class="font-bigger">
                <span><i class="bi-person-fill-add me-2"></i></span>
                <span v-if="card.min_team != card.max_team">${ card.min_team }$ - ${ card.max_team }$</span>
                <span v-else>${ card.min_team }$</span>
            </p>
            <p>Нужно собрать <points-badge :points="card.points_to_succeed"/></p>

            <div v-for="condition in ['on_success', 'on_failure']"
                 class="card-effect py-3 bg-gradient"
                 :set="effects = parseCardEffect(card[condition])"
                 :class="{'card-effect-success': condition == 'on_success', 'card-effect-failure': condition == 'on_failure'}">

                <div><small><small>${ condition == 'on_success' ? 'При успехе' : 'При провале' }$</small></small></div>

                <div v-if="!isConditionEffectsVisible(condition)">
                    Эффект скрыт
                </div>

                <div v-if="isConditionEffectsVisible(condition)">
                    <div v-for="effect in effects" class="mb-3">
                        <div v-if="effect.name">
                            <div v-if="effect.name == 'change_player_points'">
                                <div>
                                    ${ buildCategoriesDescription(effect.payload.categories_of_players) }$ получает <points-badge :signed="true" :points="effect.payload.points" :duration="effect.payload.rounds_to_apply"/>
                                </div>
                            </div>
                            <div v-if="effect.name == 'give_overpayment'">
                                <div>
                                    ${ buildCategoriesDescription(effect.payload.categories_of_players) }$ получает переплату
                                </div>
                            </div>
                            <div v-if="effect.name == 'cancel_effects'">
                                <div>
                                    Отменяет ${ {'all_effects': 'все', 'positive_effects': 'положительные', 'negative_effects': 'отрицательные'}[effect.payload.cancel] }$ эффекты у ${ buildCategoriesDescription(effect.payload.categories_of_players) }$
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>


    <script type="text/javascript" charset="utf-8">
        const { createApp, ref } = Vue
        var socket = io();

        const app = createApp({
            setup() {
                return {
                    room: ref({}),

                    showPortraitOptions: ref(false),
                    debug: ref(false),
                    selectedCard: ref(null),
                    playerProjectBid: ref(0),
                    projectTeamMembersSelection: ref({}),
                    playerName: '{{ player_name }}',
                    roomId: '{{ room_id }}',

                    config: {},
                    roundResults: ref(null),
                    finalRating: ref(null),
                    gameConfig: ref({
                        rounds: 10,
                        initialPlayerPoints: 10,
                        cardEffectVisibility: {
                            'onSuccess': {
                                'leader': true,
                                'players': true
                            },
                            'onFailure': {
                                'leader': true,
                                'players': true
                            }
                        }
                    }),
                    cardDeck: ref([])
                }
            },
            computed: {
                game() {
                    return this.room.game || {}
                },
                player() {
                    return this.room.players?.find(p => p.name == this.playerName) || {}
                },
                portraitIds() {
                    let pls = this.room.players || [];

                    let portraitIds = {};
                    pls.forEach(p => {
                        portraitIds[p.name] = p.portrait_id;
                    });

                    return portraitIds;
                },
                roundStage() {
                    // project developing
                    if (this.game.team && this.game.team.length > 0) {
                        return 2
                    }

                    // team selection
                    if (this.game.cards_selected_by_leader && this.game.cards_selected_by_leader.length > 0) {
                        return 1
                    }

                    // card selection
                    return 0
                },
                projectTeamMaxMembers() {
                    return Math.max.apply(null, this.game.cards_selected_by_leader.map(c => c.max_team))
                },
                selectedProjectTeamMembers() {
                    let selectedPlayers = [];
                    for (player in this.projectTeamMembersSelection) {
                        if (this.projectTeamMembersSelection[player] === true) {
                            selectedPlayers.push(player)
                        }
                    }

                    return selectedPlayers;
                }
            },
            methods: {
                selectPortrait(id) {
                    socket.emit('select_player_portrait', {
                        "portrait_id": id,
                        "room_id": this.roomId,
                        "player_name": this.playerName
                    });
                },
                isPlayerProjectParticipant() {
                    return this.roundStage === 2 && this.game.team.includes(this.playerName);
                },
                isActivePlayer() {
                    return this.playerName === this.game.active_player
                },
                isLeader() {
                    return this.playerName == this.game.leader;
                },
                addNewCardToGameDeck() {
                    this.cardDeck.push({
                        name: 'New card',
                        points_to_succeed: 20,
                        min_team: 1,
                        max_team: 2,
                        on_success: '{"name": "change_player_points", "type": "positive", "payload": {"rounds_to_apply": 7, "categories_of_players": ["leader", "team"], "points": 10, "players": []}}',
                        on_failure: ''
                    })
                },
                rmCardFromGameDeck(idx) {
                    this.cardDeck.splice(idx, 1);
                },
                startGame() {
                    socket.emit('start_game', {
                        "room_id": this.roomId,
                        "cards": this.cardDeck,
                        "rounds": this.gameConfig.rounds,
                        "initial_player_points": this.gameConfig.initialPlayerPoints,
                        "card_effect_visibility": this.gameConfig.cardEffectVisibility
                    });
                },
                makeProjectDeposit(points) {
                    let payload = {
                        "room_id": this.roomId,
                        "player_name": this.playerName,
                        "points": points
                    }
                    socket.emit('make_project_deposit', payload)
                    this.playerProjectBid = 0;
                },
                submitCardsSelection() {
                    let payload = {
                        "room_id": this.roomId,
                        "selected_cards_ids": [this.selectedCard],
                    }
                    socket.emit('select_cards_from_table', payload)
                    this.selectedCard = null;
                },
                submitProjectTeamSelection() {
                    let payload = {
                        "room_id": this.roomId,
                        "selected_players": this.selectedProjectTeamMembers,
                    }
                    socket.emit('select_team_for_round', payload)
                    this.projectTeamMembersSelection = {};
                }
            },
            mounted() {
                let vm = this;

                socket.on('connect', function() {
                    socket.emit('player_enter', {"player_name": vm.playerName, "room_id": vm.roomId});
                });

                let listeners = {
                    'room_entered': function(arg) {
                        vm.room = arg;
                    },
                    'game_started': function(arg) {
                        vm.room = arg;
                    },
                    'round_started': function(arg) {
                        vm.room = arg;
                    },
                    'move_started': function(arg) {
                        vm.room = arg;
                    },
                    'player_points_changed': function(arg) {
                        vm.room = arg;
                    },
                    'cards_for_round_selected': function(arg) {
                        vm.room = arg;
                    },
                    'team_for_round_selected': function(arg) {
                        vm.room = arg;
                    },
                    'round_result': function(arg) {
                        vm.roundResults = arg.is_success;
                    },
                    'player_portrait_selected': function(arg) {
                        vm.room = arg;
                    },
                    'game_ended': function(arg) {
                        vm.finalRating = arg.rating;
                    }
                }

                for (const [eventName, cb] of Object.entries(listeners)) {
                    socket.on(eventName, (arg) => {
                        console.log(eventName, arg)
                        cb(arg)
                    });
                }
            },
        });
        app.component('TableCard', {
            props: ['card', 'effectsVisibility', 'isLeader'],
            methods: {
                parseCardEffect(effect) {
                    return effect ? JSON.parse(effect) : {}
                },
                isConditionEffectsVisible(condition) {
                    let key = condition == 'on_success' ? 'onSuccess' : 'onFailure';
                    let group = this.isLeader ? 'leader' : 'players';

                    return this.effectsVisibility[key][group] === true;
                },
                buildCategoriesDescription(categories) {
                    let translates = [
                        categories.includes('leader') ? 'лидер' : '',
                        categories.includes('team') ? 'команда' : '',
                        categories.includes('all') ? 'каждый игрок' : '',
                        categories.includes('others') ? 'Каждый, кроме лидера и команды' : '',
                    ].filter(i => Boolean(i)).join(' и ');

                    return translates.charAt(0).toUpperCase() + translates.slice(1)
                }
            },
            template: '#TableCard',
        });
        app.component('PointsBadge', {
            props: ['points', 'duration', 'signed'],
            template: '<span class="badge rounded-pill bg-warning text-dark"><strong><span v-if="signed && points > 0">+</span>${ points }$</strong><span v-if="duration > 1">&nbsp;&nbsp;/&nbsp;&nbsp;${ duration }$&nbsp;<i class="bi-hourglass-top"></i></span></span>',
        });

        app.config.compilerOptions.delimiters = ["${", "}$"];
        app.mount('#app')

    </script>
</body>
</html>