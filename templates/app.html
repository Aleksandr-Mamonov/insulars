<html>

<head>
    <title>Game | {{ player_name }}</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
        integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
        crossorigin="anonymous"></script>

    <style>
        .card {
            min-width: 150px;
            width: 150px;
            min-height: 200px;
            border: 2px #bbb solid;
            display: inline-block;
            margin-left: 5px;
            text-align: center;
        }

        .card-active {
            min-width: 300px;
            width: 300px;
            min-height: 400px;
            border: 2px #000 solid;
            display: inline-block;
            margin-left: 5px;
            text-align: center;
        }

        .overlay {
            top: 0;
            left: 0;
            padding-top: 100px;
            text-align: center;
            position: absolute;
            z-index: 100;
            min-width: 100%;
            min-height: 100%;
            border: rgb(0, 17, 255) 1px solid;
            background-color: lavender;
        }

        .card-effect {}

        .card-effect-success {
            background-color: #bff;
        }

        .card-effect-failure {
            background-color: #fbf;
        }
    </style>
</head>
<!--todo - leader can not select himself for project team-->

<body id="app">

    <p><a href="/">New game</a></p>
    <h2>You are ${playerName}$</h2>

    <div v-if="finalRating !== null" class="overlay">
        <h2>Игра окончена!</h2>
        <div v-for="rank in finalRating">${ rank[0] }$ - &#129689; ${ rank[1] }$</div>

        <button @click="finalRating = null; game = null">Закрыть</button>
    </div>

    <div id="lobby-layout" v-if="game === null">
        <a href="/?room_id={{room_id}}">Invite another player</a>
        <h1>Room</h1>

        <ul>
            <li v-for="p in players">${p.player_name}$</li>
        </ul>

        <button :disabled="players.length < config.MIN_PLAYERS || players.length > config.MAX_PLAYERS"
            v-if="player.is_owner" @click="startGame">Start game</button>

        <details v-if="player.is_owner">
            <summary>Configure</summary>

            <div>
                <label>Number of rounds
                    <input v-model="gameConfig.rounds" />
                </label>
            </div>
            <div>
                <label>Initial player points
                    <input v-model="gameConfig.initialPlayerPoints" />
                </label>
            </div>
            <h4>Card deck</h4>
            <div v-for="(card, idx) in cardDeck" style="padding: 10px; margin: 10px; background: lightgray">
                <label>Name
                    <input v-model="card.name" />
                </label>
                <label>Points to succeed
                    <input v-model="card.points_to_succeed" />
                </label>
                <label>Min team
                    <input v-model="card.min_team" />
                </label>
                <label>Max team
                    <input v-model="card.max_team" />
                </label>
                <div>
                    <label>On success
                        <textarea rows=6 cols=70 v-model="card.on_success"></textarea>
                    </label>
                </div>
                <div>
                    <label>On failure
                        <textarea rows=6 cols=70 v-model="card.on_failure"></textarea>
                    </label>
                </div>

                <button @click="rmCardFromGameDeck(idx)" v-if="cardDeck.length > 1">Rm card</button>
            </div>

            <button @click="addNewCardToGameDeck()">Add card</button>

            <h5>Effect samples</h5>
            <pre>{"type": "change_player_points", "payload": {"rounds_to_apply": 1, "points": 10,"players": []}}</pre>
            <pre>{"type": "leadership_ban_next_time", "payload": {"player": null}}</pre>
        </details>
    </div>

    <div id="game-layout" v-if="game !== null">
        <h3>Player points: ${game.all_players_points[playerName]}$</h3>

        <p>Round: ${game.round}$ (${ roundStage}$), ${ game.leader }$ is leader, ${ game.active_player }$ is active
            player</p>

        <div v-if="game.cards_on_table && game.cards_on_table.length > 0">
            <div v-if="isLeader()">
                <div>
                    <div class="card" v-for="card in game.cards_on_table" :key="card_id" @click="toggleCard(card)">

                        <p>${ card.name }$</p>
                        <p>&#128100; ${ card.min_team }$ - ${ card.max_team }$</p>
                        <p>&#129689; ${ card.points_to_succeed }$</p>

                        <div v-for="condition in ['on_success', 'on_failure']" class="card-effect"
                            :set="effect = parseCardEffect(card[condition])"
                            :class="{'card-effect-success': condition == 'on_success', 'card-effect-failure': condition == 'on_failure'}">

                            <div v-if="effect.type">
                                <h6>${ effect.type }$</h6>

                                <div v-if="effect.type == 'change_player_points'">
                                    <p>Give points to project team members</p>
                                    <div>
                                        <span>&#129689;&nbsp;<span
                                                v-if="effect.payload.points > 0">+</span>${effect.payload.points}$</span>
                                        <span v-if="effect.payload.rounds_to_apply > 1">
                                            &nbsp;/&nbsp;&#8987;&nbsp;${ effect.payload.rounds_to_apply }$
                                        </span>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <p v-if="isCardSelected(card)">выбрана</p>
                    </div>
                </div>
                <button type="button" @click="submitCardsSelection()" :disabled="!selectedCards.length">Выбрать</button>
            </div>
            <div v-if="!isLeader()">
                <div>
                    <div class="card" v-for="card in game.cards_on_table" :key="card_id">
                        <p>${ card.name }$</p>
                        <p>&#128100; ${ card.min_team }$ - ${ card.max_team }$</p>
                        <p>&#129689; ${ card.points_to_succeed }$</p>

                        <div v-for="condition in ['on_success', 'on_failure']" class="card-effect"
                            :set="effect = parseCardEffect(card[condition])"
                            :class="{'card-effect-success': condition == 'on_success', 'card-effect-failure': condition == 'on_failure'}">

                            <div v-if="effect.type">
                                <h6>${ effect.type }$</h6>

                                <div v-if="effect.type == 'change_player_points'">
                                    <p>Give points to project team members</p>
                                    <div>
                                        <span>&#129689;&nbsp;<span
                                                v-if="effect.payload.points > 0">+</span>${effect.payload.points}$</span>
                                        <span v-if="effect.payload.rounds_to_apply > 1">
                                            &nbsp;/&nbsp;&#8987;&nbsp;${ effect.payload.rounds_to_apply }$
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="roundStage > 0">
            <div class="card" v-for="card in game.cards_selected_by_leader" :key="card_id">
                <p>${ card.name }$</p>
                <p>&#128100; ${ card.min_team }$ - ${ card.max_team }$</p>
                <p>&#129689; ${ card.points_to_succeed }$</p>

                <div v-for="condition in ['on_success', 'on_failure']" class="card-effect"
                    :set="effect = parseCardEffect(card[condition])"
                    :class="{'card-effect-success': condition == 'on_success', 'card-effect-failure': condition == 'on_failure'}">

                    <div v-if="effect.type">
                        <h6>${ effect.type }$</h6>

                        <div v-if="effect.type == 'change_player_points'">
                            <p>Give points to project team members</p>
                            <div>
                                <span>&#129689;&nbsp;<span
                                        v-if="effect.payload.points > 0">+</span>${effect.payload.points}$</span>
                                <span v-if="effect.payload.rounds_to_apply > 1">
                                    &#8987;&nbsp;${ effect.payload.rounds_to_apply }$
                                </span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div v-if="roundStage === 1">
                <p>Leader is selecting project team</p>
            </div>
        </div>

        <template v-if="playerName == game.active_player">
            <b>It's your move!</b>
        </template>

        <p>Players:</p>
        <ul>
            <li v-for="playerName in game.players">
                <label>
                    <input type="checkbox"
                        :disabled="(selectedProjectTeamMembers.length >= projectTeamMaxMembers && !selectedProjectTeamMembers.includes(playerName)) || game.leader === playerName"
                        v-model="projectTeamMembersSelection[playerName]" v-if="isLeader() && roundStage === 1">
                    ${ playerName }$ <span v-if="playerName == game.leader">&#128081;</span>
                </label>
            </li>
        </ul>
        <div v-if="isLeader() && roundStage === 1">
            <button type="button" @click="submitProjectTeamSelection()">
                Подтвердить</button>
        </div>

        <div v-if="roundStage === 2 && isPlayerProjectParticipant() && isActivePlayer()">
            <label>Выберите, сколько вложить в проект: ${ playerProjectBid }$</label>
            <input type="range" v-model="playerProjectBid" min="0" :max="game.all_players_points[playerName]" />

            <button type="button" @click="makeProjectDeposit(playerProjectBid)">Подтвердить</button>
        </div>

        <div v-if="roundStage === 2 && (!isPlayerProjectParticipant() || !isActivePlayer())">
            <p>Ждем результатов строительства</p>
        </div>

        <div v-if="roundResults !== null" class="overlay">
            Здание
            <span v-if="roundResults === false" style="color: red"> не построено</span>
            <span v-if="roundResults !== false" style="color: green">построено</span>

            <div>
                <button @click="roundResults = null">Закрыть</button>
            </div>
        </div>

        <div v-if="game.effects_to_apply && game.effects_to_apply.length > 0">
            Действующие эффекты:
            <ul>
                <li v-for="effect in game.effects_to_apply">
                    ${ effect.type }$
                    <span v-if="effect.type == 'change_player_points'">
                        <span>&#129689;&nbsp;<span
                                v-if="effect.payload.points > 0">+</span>${effect.payload.points}$</span>
                        <span>
                            &nbsp;/&nbsp;&#8987;&nbsp;${ effect.payload.rounds_to_apply }$
                        </span>
                        <span> for ${ effect.payload.players.join(', ') }$</span>
                    </span>
                </li>
            </ul>
        </div>

        <hr />
        <details>
            <summary>Game</summary>
            <p>Common account: ${game.round_common_account_points}$ points</p>
            <pre>${ game }$</pre>
        </details>

    </div>

    <script type="text/javascript" charset="utf-8">
        const { createApp, ref } = Vue
        var socket = io();

        createApp({
            setup() {
                return {
                    selectedCards: ref([]),
                    playerProjectBid: ref(0),
                    projectTeamMembersSelection: ref({}),
                    playerName: '{{ player_name }}',
                    roomId: '{{ room_id }}',
                    players: ref([]),
                    config: {},
                    game: ref(null),
                    roundResults: ref(null),
                    finalRating: ref(null),
                    gameConfig: ref({
                        rounds: 3,
                        initialPlayerPoints: 10,
                    }),
                    cardDeck: ref([
                        {
                            name: 'Station',
                            points_to_succeed: 20,
                            min_team: 1,
                            max_team: 2,
                            on_success: '{"type": "change_player_points", "payload": {"rounds_to_apply": 1, "points": 10,"players": []}}',
                            on_failure: '{"type": "change_player_points", "payload": {"rounds_to_apply": 1, "points": -15, "players": []}}'
                        }
                    ])
                }
            },
            computed: {
                player() {
                    return this.players.filter(p => p.player_name == this.playerName)[0] || {}
                },
                roundStage() {
                    // project developing
                    if (this.game.team_selected_by_leader && this.game.team_selected_by_leader.length > 0) {
                        return 2
                    }

                    // team selection
                    if (this.game.cards_selected_by_leader && this.game.cards_selected_by_leader.length > 0) {
                        return 1
                    }

                    // card selection
                    return 0
                },
                projectTeamMaxMembers() {
                    return Math.max.apply(null, this.game.cards_selected_by_leader.map(c => c.max_team))
                },
                selectedProjectTeamMembers() {
                    let selectedPlayers = [];
                    for (player in this.projectTeamMembersSelection) {
                        if (this.projectTeamMembersSelection[player] === true) {
                            selectedPlayers.push(player)
                        }
                    }

                    return selectedPlayers;
                }
            },
            methods: {
                parseCardEffect(effect) {
                    return effect ? JSON.parse(effect) : {}
                },
                isPlayerProjectParticipant() {
                    return this.roundStage === 2 && this.game.team_selected_by_leader.includes(this.playerName);
                },
                isActivePlayer() {
                    return this.playerName === this.game.active_player
                },
                isLeader() {
                    return this.playerName == this.game.leader;
                },
                isCardSelected(card) {
                    return this.selectedCards.map(c => c.card_id).includes(card.card_id);
                },
                addNewCardToGameDeck() {
                    this.cardDeck.push({
                        name: 'New card',
                        points_to_succeed: 20,
                        min_team: 1,
                        max_team: 2,
                        on_success: '{"type": "change_player_points", "payload": {"rounds_to_apply": 1, "points": 10,"players": []}}',
                        on_failure: ''
                    })
                },
                rmCardFromGameDeck(idx) {
                    this.cardDeck.splice(idx, 1);
                },
                toggleCard(card) {
                    if (!this.isCardSelected(card)) {
                        this.selectedCards.push(card);
                    } else {
                        this.selectedCards = this.selectedCards.filter(c => c.card_id !== card.card_id);
                    }
                },
                startGame() {
                    socket.emit('start_game', {
                        "room_id": this.roomId,
                        "cards": this.cardDeck,
                        "rounds": this.gameConfig.rounds,
                        "initial_player_points": this.gameConfig.initialPlayerPoints
                    });
                    console.log('Game started!')
                },
                makeProjectDeposit(points) {
                    let payload = {
                        "room_id": this.roomId,
                        "player_name": this.playerName,
                        "points": points
                    }
                    socket.emit('make_project_deposit', payload)
                    this.playerProjectBid = 0;
                },
                submitCardsSelection() {
                    let payload = {
                        "room_id": this.roomId,
                        "selected_cards_ids": this.selectedCards.map(c => c.card_id),
                    }
                    socket.emit('select_cards_from_table', payload)
                    this.selectedCards = [];
                },
                submitProjectTeamSelection() {
                    let payload = {
                        "room_id": this.roomId,
                        "selected_players": this.selectedProjectTeamMembers,
                    }
                    socket.emit('select_team_for_round', payload)
                    this.projectTeamMembersSelection = {};
                }
            },
            mounted() {
                let vm = this;
                socket.on('connect', function () {
                    console.log('connected')
                    socket.emit('player_enter', { "player_name": vm.playerName, "room_id": vm.roomId });
                });
                socket.on("room_entered", (arg) => {
                    vm.players = arg.players;
                    vm.config = arg.config;
                    vm.game = arg.game
                });
                socket.on('game_started', (arg) => {
                    console.log(arg)
                    vm.game = arg.game
                });
                socket.on('game_ended', (arg) => {
                    vm.finalRating = arg.rating;
                });
                socket.on('round_started', (arg) => {
                    console.log(arg)
                    vm.game = arg.game
                });
                socket.on('move_started', (arg) => {
                    console.log(arg)
                    vm.game = arg.game
                });
                socket.on('player_points_changed', (arg) => {
                    console.log(arg)
                    vm.game = arg.game
                });
                socket.on('added_to_common_account', (arg) => {
                    console.log(arg)
                    vm.game = arg.game
                });
                socket.on('cards_for_round_selected', (arg) => {
                    vm.game = arg.game
                });
                socket.on('team_for_round_selected', (arg) => {
                    console.log(arg)
                    vm.game = arg.game
                })
                socket.on('round_result', (arg) => {
                    console.log(arg)
                    vm.roundResults = arg.is_success
                })
            },
            delimiters: ["${", "}$"],

        }).mount('#app')

    </script>
</body>

</html>