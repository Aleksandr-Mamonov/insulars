<html>

<head>
    <title>Game | {{ player_name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
        integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
        crossorigin="anonymous"></script>

    <style>
        .card {
            min-width: 250px;
            width: 250px;
            min-height: 300px;
            display: inline-block;
            margin-left: 5px;
            text-align: center;
        }

        .card-active {
            min-width: 300px;
            width: 300px;
            min-height: 400px;
            display: inline-block;
            margin-left: 5px;
            text-align: center;
        }

        .overlay {
            top: 0;
            left: 0;
            padding-top: 100px;
            text-align: center;
            position: absolute;
            z-index: 100;
            min-width: 100%;
            min-height: 100%;
            border: rgb(0, 17, 255) 1px solid;
            background-color: lavender;
        }

        .card-effect {}

        .card-effect-success {
            background-color: #7FFF00;
        }

        .card-effect-failure {
            background-color: #DC143C;
            color: #fff;
        }

        .portrait {
            background: #FFEBCD;
            background-size: contain;
            background-repeat: no-repeat;
            min-height: 150px;
            max-height: 150px;
            min-width: 150px;
            max-width: 150px;
        }

        .portrait p {
            overflow-wrap: break-word;
        }

        .portrait div span {
            background-color: #fff;
            opacity: 0.85;
            font-size: 1rem;
            color: #000;
            border-radius:10%;
        }

        #portrait-options img {
            width: 220px;
        }
    </style>
</head>
<!--todo - leader can not select himself for project team-->

<body>
    <div id="app">
        <div class="container">
            <div class="row py-2">
                <div class="col">
                    <p><a href="/">Новая игра</a></p>
                </div>

                <div class="col text-end">
                    <span style="color: #fef;" v-if="game !== null" @click="debug = !debug">debug</span>
                </div>
            </div>

            <div class="row" v-if="debug === true">
                <div class="col">
                    <p>Common account: ${game.round_common_account_points}$ points</p>
                    <pre>${ game }$</pre>
                    <pre>Stage ${ roundStage }$</pre>
                </div>
            </div>
        </div>


        <div v-if="finalRating !== null" class="overlay">
            <h2>Игра окончена!</h2>
            <div v-for="rank in finalRating">${ rank[0] }$ - &#129689; ${ rank[1] }$</div>

            <button @click="finalRating = null; game = null">Закрыть</button>
        </div>

        <div v-if="roundResults !== null" class="overlay">
            Здание
            <span v-if="roundResults === false" style="color: red"> не построено</span>
            <span v-if="roundResults !== false" style="color: green">построено</span>

            <div>
                <button @click="roundResults = null">Закрыть</button>
            </div>
        </div>

        <div id="lobby-layout" v-if="game === null" class="container">
            <div class="row">
                <div class="col">
                    <h1>Лобби</h1>
                    <a href="/?room_id={{room_id}}" target="_blank">Пригласить другого игрока</a>

                    <!-- Player list -->
                    <div class="row">
                        <div class="col-12 mt-4">
                            <p>Сейчас в комнате:</p>
                        </div>

                        <div class="col-auto"
                             v-for="p in players">
                            <div class="portrait p-2" :style="{'background-image': 'url(/static/portrait' + (playerPortraits[p.player_name] || 0) + '.jpg)'}">
                                <div>
                                    <p><span class="p-1"><strong>${ p.player_name }$</strong></span></p>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 my-3">
                            <button type="button"
                                    @click="showPortraitOptions = !showPortraitOptions"
                                    class="btn btn-sm btn-outline-secondary">${ !showPortraitOptions ? 'Выбрать портрет' : 'Готово' }$</button>

                            <div v-if="showPortraitOptions === true" id="portrait-options" class="mt-3">
                                {% for i in range(4) %}
                                    <div class="row">
                                        <div class="col">
                                        {% for j in range(4) %}
                                            <img src="{{ url_for('static', filename='portrait' ~ ((i * 4) + 1 + j) ~ '.jpg') }}"
                                                 class="border border-5"
                                                 :class="{'border-info': portrait === {{ (i * 4) + 1 + j }}}"
                                                 @click="selectPortrait({{ (i * 4) + 1 + j }})">
                                        {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="col-12 my-3">
                            <button :disabled="players.length < config.MIN_PLAYERS || players.length > config.MAX_PLAYERS"
                                    v-if="player.is_owner"
                                    class="btn btn-primary"
                                    @click="startGame">Начать игру</button>
                        </div>
                    </div>

                    <details v-if="player.is_owner">
                        <summary>Настроить</summary>

                        <div>
                            <label>Number of rounds
                                <input v-model="gameConfig.rounds" />
                            </label>
                        </div>
                        <div>
                            <label>Initial player points
                                <input v-model="gameConfig.initialPlayerPoints" />
                            </label>
                        </div>
                        <h4>Card effect visibility</h4>
                        <div>
                            <p>On success effect</p>
                            <label>Leader
                                <input type="checkbox" v-model="gameConfig.cardEffectVisibility.onSuccess.leader" />
                            </label>
                            <label>Players
                                <input type="checkbox" v-model="gameConfig.cardEffectVisibility.onSuccess.players" />
                            </label>
                        </div>
                        <div>
                            <p>On failure effect</p>
                            <label>Leader
                                <input type="checkbox" v-model="gameConfig.cardEffectVisibility.onFailure.leader" />
                            </label>
                            <label>PLayers
                                <input type="checkbox" v-model="gameConfig.cardEffectVisibility.onFailure.players" />
                            </label>
                        </div>

                        <h4>Card deck</h4>
                        <div v-for="(card, idx) in cardDeck" style="padding: 10px; margin: 10px; background: lightgray">
                            <label>Name
                                <input v-model="card.name" />
                            </label>
                            <label>Points to succeed
                                <input v-model="card.points_to_succeed" />
                            </label>
                            <label>Min team
                                <input v-model="card.min_team" />
                            </label>
                            <label>Max team
                                <input v-model="card.max_team" />
                            </label>
                            <div>
                                <label>On success
                                    <textarea rows=6 cols=70 v-model="card.on_success"></textarea>
                                </label>
                            </div>
                            <div>
                                <label>On failure
                                    <textarea rows=6 cols=70 v-model="card.on_failure"></textarea>
                                </label>
                            </div>

                            <button @click="rmCardFromGameDeck(idx)" v-if="cardDeck.length > 1">Rm card</button>
                        </div>

                        <button @click="addNewCardToGameDeck()">Add card</button>

                        <h5>Effect samples</h5>
                        <pre>{"type": "change_player_points", "payload": {"rounds_to_apply": 1, "points": 10,"players": []}}</pre>
                        <pre>{"type": "leadership_ban_next_time", "payload": {"player": null}}</pre>
                    </details>
                </div>
            </div>
        </div>

        <div id="game-layout" v-if="game !== null">
            <div class="container">
                <div class="row">
                    <div class="col">
                         <h5>У вас очков: &#129689;<strong>${game.all_players_points[playerName]}$</strong></h5>

                        <p>Раунд ${game.round}$ <span style="color: #ccc">/ ${game.rounds}$</p>
                        <p>Сейчас ходит ${ game.active_player }$</p>
                    </div>
                </div>

                <!-- Players list -->
                <div class="row mb-4">
                    <div class="col-auto mx-1"
                         v-for="plName in game.players">
                        <div class="portrait border p-2"
                             :style="{'background-image': 'url(/static/portrait' + (playerPortraits[plName] || 0) + '.jpg)'}"
                             :class="{'border-info border-3': game.active_player == plName, 'border-secondary-subtle': game.active_player != plName, 'shadow': projectTeamMembersSelection[plName]}">

                            <div>
                                <p>
                                    <input type="checkbox"
                                       style="width: 25px; height: 25px;"
                                       :disabled="(selectedProjectTeamMembers.length >= projectTeamMaxMembers && !selectedProjectTeamMembers.includes(plName))"
                                       v-model="projectTeamMembersSelection[plName]"
                                       v-if="isLeader() && roundStage === 1 && game.leader !== plName">
                                    <span class="p-1"><strong><span v-if="plName == game.leader">&#128081;</span><span v-if="game.team && game.team.includes(plName)">&#128119;</span>${ plName }$</strong></span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div v-if="isLeader() && roundStage === 1">
                        <div class="row mt-3">
                            <div class="col">
                                <button type="button" class="btn btn-primary" @click="submitProjectTeamSelection() && projectTeamMembersSelection.length > 0">Подтвердить выбор команды</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cards -->
                <div class="row justify-content-sm-center bg-gradient bg-light py-4 shadow">
                    <div class="col text-center">
                        <div v-if="game.cards_on_table && game.cards_on_table.length > 0">
                            <div v-if="isLeader()">
                                <div class="row">
                                    <div class="col">
                                        <table-card @click="toggleCard(card)"
                                            :card="card"
                                            :class="{'border-3 shadow-lg border-info': isCardSelected(card)}"
                                            v-for="card in game.cards_on_table"
                                            :key="card.card_id"
                                            :effects-visibility="game.card_effect_visibility"
                                            :is-leader="isLeader()" />

                                    </div>
                                </div>

                                <div class="row mt-3">
                                    <div class="col">
                                        <button type="button"
                                                class="btn btn-primary"
                                                @click="submitCardsSelection()"
                                                :disabled="!selectedCards.length">Подтвердить выбор проекта</button>
                                    </div>
                                </div>
                            </div>

                            <div v-if="!isLeader()">
                                <div class="row">
                                    <div class="col">
                                        <table-card :card="card"
                                                    v-for="card in game.cards_on_table"
                                                    :key="card.card_id"
                                                    :effects-visibility="game.card_effect_visibility"
                                                    :is-leader="isLeader()"/>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div v-if="roundStage > 0">
                            <div class="row">
                                <div class="col">
                                    <table-card :card="card"
                                                v-for="card in game.cards_selected_by_leader"
                                                :key="card.card_id"
                                                :effects-visibility="game.card_effect_visibility"
                                                :is-leader="isLeader()"/>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>

                <!-- Current state notification -->
                <div class="row justify-content-sm-center py-3">
                    <div class="col">
                        <div v-if="roundStage === 1">
                            <p>Лидер выбирает команду... </p>
                        </div>

                        <template v-if="isActivePlayer()">
                            <b>Ваш ход!</b>
                        </template>

                        <div v-if="roundStage === 2 && isPlayerProjectParticipant() && isActivePlayer()">
                            <label>Выберите, сколько вложить в проект: ${ playerProjectBid }$</label>
                            <input type="range"
                                   v-model="playerProjectBid"
                                   min="0"
                                   :max="game.all_players_points[playerName]" />

                            <div class="row mt-3">
                                <div class="col">
                                    <button type="button"
                                            class="btn btn-primary"
                                            @click="makeProjectDeposit(playerProjectBid)">Подтвердить</button>
                                </div>
                            </div>
                        </div>

                        <div v-if="roundStage === 2 && (!isPlayerProjectParticipant() || !isActivePlayer())">
                            <p>Ждем результатов строительства</p>
                        </div>
                    </div>
                </div>

                <!-- Effects to apply -->
                <div class="row justify-content-sm-center">
                    <div class="col">
                        <div v-if="game.effects_to_apply && game.effects_to_apply.length > 0">
                            Действующие эффекты:
                            <ul>
                                <li v-for="effect in game.effects_to_apply">
                                    <span v-if="effect.name == 'change_player_points'">
                                        <span>&#129689;&nbsp;<span
                                                v-if="effect.payload.points > 0">+</span>${effect.payload.points}$</span>
                                        <span>
                                            &nbsp;/&nbsp;&#8987;&nbsp;${ effect.payload.rounds_to_apply }$
                                        </span>
                                        <span> for ${ effect.payload.players.join(', ') }$</span>
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <template id="TableCard">
        <div class="card shadow-sm mx-3 border-1 py-4">
            <h6>${ card.name }$</h6>
            <p>&#128100; ${ card.min_team }$ - ${ card.max_team }$</p>
            <p>Нужно собрать &#129689; ${ card.points_to_succeed }$</p>

            <div v-for="condition in ['on_success', 'on_failure']"
                 class="card-effect py-3"
                 :set="effects = parseCardEffect(card[condition])"
                 :class="{'card-effect-success': condition == 'on_success', 'card-effect-failure': condition == 'on_failure'}">

                <div><small><small>${ condition == 'on_success' ? 'При успехе' : 'При провале' }$</small></small></div>

                <div v-if="!isConditionEffectsVisible(condition)">
                    Эффект скрыт
                </div>

                <div v-if="isConditionEffectsVisible(condition)">
                    <div v-for="effect in effects" class="mb-3">
                        <div v-if="effect.name">
                            <div v-if="effect.name == 'change_player_points'">
                                <div>
                                    ${ buildCategoriesDescription(effect.payload.categories_of_players) }$ получает
                                    <span>&#129689;&nbsp;<span v-if="effect.payload.points > 0">+</span>${ effect.payload.points }$</span>
                                    <span v-if="effect.payload.rounds_to_apply > 1"> / &#8987;&nbsp;${ effect.payload.rounds_to_apply }$</span>
                                </div>
                            </div>
                            <div v-if="effect.name == 'give_overpayment'">
                                <div>
                                    ${ buildCategoriesDescription(effect.payload.categories_of_players) }$ получает переплату
                                </div>
                            </div>
                            <div v-if="effect.name == 'cancel_effects'">
                                <div>
                                    Отменяет ${ {'all_effects': 'все', 'positive_effects': 'положительные', 'negative_effects': 'отрицательные'}[effect.payload.cancel] }$ эффекты у ${ buildCategoriesDescription(effect.payload.categories_of_players) }$
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>


    <script type="text/javascript" charset="utf-8">
        const { createApp, ref } = Vue
        var socket = io();

        const app = createApp({
            setup() {
                return {
                    showPortraitOptions: ref(false),
                    playerPortraits: ref({}),
                    portrait: ref(0),
                    debug: ref(false),
                    selectedCards: ref([]),
                    playerProjectBid: ref(0),
                    projectTeamMembersSelection: ref({}),
                    playerName: '{{ player_name }}',
                    roomId: '{{ room_id }}',
                    players: ref([]),
                    config: {},
                    game: ref(null),
                    roundResults: ref(null),
                    finalRating: ref(null),
                    gameConfig: ref({
                        rounds: 10,
                        initialPlayerPoints: 10,
                        cardEffectVisibility: {
                            'onSuccess': {
                                'leader': true,
                                'players': true
                            },
                            'onFailure': {
                                'leader': true,
                                'players': true
                            }
                        }
                    }),
                    cardDeck: ref([
                        {
                            name: 'Station',
                            points_to_succeed: 10,
                            min_team: 1,
                            max_team: 2,
                            on_success: '[{"name": "change_player_points", "type": "positive", "payload": {"rounds_to_apply": 7, "categories_of_players": ["leader", "team"], "points": 10, "players": []}}, {"name": "give_overpayment", "type": "positive", "payload": {"categories_of_players": ["leader"], "players": []}}]',
                            on_failure: '[{"name": "change_player_points", "type": "negative", "payload": {"rounds_to_apply": 7, "categories_of_players": ["leader"], "points": -3, "players": []}}]',
                        },
                        {
                            name: 'Hospital',
                            points_to_succeed: 5,
                            min_team: 1,
                            max_team: 2,
                            on_success: '[{"name": "cancel_effects", "payload": {"categories_of_players": ["all"], "players": [], "cancel": "all_effects"}}]',
                            on_failure: '[]'
                        }
                    ])
                }
            },
            computed: {
                player() {
                    return this.players.filter(p => p.player_name == this.playerName)[0] || {}
                },
                roundStage() {
                    // project developing
                    if (this.game.team && this.game.team.length > 0) {
                        return 2
                    }

                    // team selection
                    if (this.game.cards_selected_by_leader && this.game.cards_selected_by_leader.length > 0) {
                        return 1
                    }

                    // card selection
                    return 0
                },
                projectTeamMaxMembers() {
                    return Math.max.apply(null, this.game.cards_selected_by_leader.map(c => c.max_team))
                },
                selectedProjectTeamMembers() {
                    let selectedPlayers = [];
                    for (player in this.projectTeamMembersSelection) {
                        if (this.projectTeamMembersSelection[player] === true) {
                            selectedPlayers.push(player)
                        }
                    }

                    return selectedPlayers;
                }
            },
            methods: {
                selectPortrait(id) {
                    this.portrait = id;
                    socket.emit('select_player_portrait', {
                        "room_id": this.roomId,
                        "portrait_id": id,
                        "player_name": this.playerName
                    });
                },
                isPlayerProjectParticipant() {
                    return this.roundStage === 2 && this.game.team.includes(this.playerName);
                },
                isActivePlayer() {
                    return this.playerName === this.game.active_player
                },
                isLeader() {
                    return this.playerName == this.game.leader;
                },
                isCardSelected(card) {
                    return this.selectedCards.map(c => c.card_id).includes(card.card_id);
                },
                addNewCardToGameDeck() {
                    this.cardDeck.push({
                        name: 'New card',
                        points_to_succeed: 20,
                        min_team: 1,
                        max_team: 2,
                        on_success: '{"name": "change_player_points", "type": "positive", "payload": {"rounds_to_apply": 7, "categories_of_players": ["leader", "team"], "points": 10, "players": []}}',
                        on_failure: ''
                    })
                },
                rmCardFromGameDeck(idx) {
                    this.cardDeck.splice(idx, 1);
                },
                toggleCard(card) {
                    if (!this.isCardSelected(card)) {
                        this.selectedCards.push(card);
                    } else {
                        this.selectedCards = this.selectedCards.filter(c => c.card_id !== card.card_id);
                    }
                },
                startGame() {
                    socket.emit('start_game', {
                        "room_id": this.roomId,
                        "cards": this.cardDeck,
                        "rounds": this.gameConfig.rounds,
                        "initial_player_points": this.gameConfig.initialPlayerPoints,
                        "card_effect_visibility": this.gameConfig.cardEffectVisibility
                    });
                    console.log('Game started!')
                },
                makeProjectDeposit(points) {
                    let payload = {
                        "room_id": this.roomId,
                        "player_name": this.playerName,
                        "points": points
                    }
                    socket.emit('make_project_deposit', payload)
                    this.playerProjectBid = 0;
                },
                submitCardsSelection() {
                    let payload = {
                        "room_id": this.roomId,
                        "selected_cards_ids": this.selectedCards.map(c => c.card_id),
                    }
                    socket.emit('select_cards_from_table', payload)
                    this.selectedCards = [];
                },
                submitProjectTeamSelection() {
                    let payload = {
                        "room_id": this.roomId,
                        "selected_players": this.selectedProjectTeamMembers,
                    }
                    socket.emit('select_team_for_round', payload)
                    this.projectTeamMembersSelection = {};
                }
            },
            mounted() {
                let vm = this;

                let listeners = {
                    'connect': function() {
                        socket.emit('player_enter', { "player_name": vm.playerName, "room_id": vm.roomId });
                    },
                    'room_entered': function(arg) {
                        vm.players = arg.players;
                        vm.config = arg.config;
                        vm.game = arg.game;
                    },
                    'game_started': function(arg) {
                        vm.game = arg.game;
                    },
                    'game_ended': function(arg) {
                        vm.finalRating = arg.rating;
                    },
                    'round_started': function(arg) {
                        vm.game = arg.game;
                    },
                    'move_started': function(arg) {
                        vm.game = arg.game;
                    },
                    'player_points_changed': function(arg) {
                        vm.game = arg.game;
                    },
                    'added_to_common_account': function(arg) {
                        vm.game = arg.game;
                    },
                    'cards_for_round_selected': function(arg) {
                        vm.game = arg.game;
                    },
                    'team_for_round_selected': function(arg) {
                        vm.game = arg.game;
                    },
                    'round_result': function(arg) {
                        vm.roundResults = arg.is_success;
                    },
                    'player_portrait_selected': function(arg) {
                        vm.playerPortraits[arg.player_name] = arg.portrait_id;
                    }
                }

                for (const [eventName, cb] of Object.entries(listeners)) {
                    socket.on(eventName, (arg) => {
                        console.log(eventName, arg)
                        cb(arg)
                    });
                }
            },
        });
        app.component('TableCard', {
            props: ['card', 'effectsVisibility', 'isLeader'],
            methods: {
                parseCardEffect(effect) {
                    return effect ? JSON.parse(effect) : {}
                },
                isConditionEffectsVisible(condition) {
                    let key = condition == 'on_success' ? 'onSuccess' : 'onFailure';
                    let group = this.isLeader ? 'leader' : 'players';

                    return this.effectsVisibility[key][group] === true;
                },
                buildCategoriesDescription(categories) {
                    let translates = [
                        categories.includes('leader') ? 'лидер' : '',
                        categories.includes('team') ? 'команда' : '',
                        categories.includes('all') ? 'каждый игрок' : '',
                        categories.includes('others') ? 'Каждый, кроме лидера и команды' : '',
                    ].filter(i => Boolean(i)).join(' и ');

                    return translates.charAt(0).toUpperCase() + translates.slice(1)
                }
            },
            template: '#TableCard',
        });

        app.config.compilerOptions.delimiters = ["${", "}$"];
        app.mount('#app')

    </script>
</body>
</html>